[gcode_macro PRINT_END]
description: Cooldown and present the print safely. Parameters: MAX_LAYER_Z, TRAVEL_SPEED, RETRACT_LENGTH, RETRACT_SPEED
# Usage in slicer:
#   PRINT_END MAX_LAYER_Z={max_layer_z} TRAVEL_SPEED={travel_speed} RETRACT_SPEED={retract_speed[0]} RETRACT_LENGTH={retract_length[0]}
variable_park_x: 5.0
variable_park_y: 230.0
gcode:
  {% set max_layer_z  = params.MAX_LAYER_Z | float %}
  {% set travel_speed = params.TRAVEL_SPEED | float * 60 | int %}
  {% set retract_length = params.RETRACT_LENGTH | float %}
  {% set retract_speed = params.RETRACT_SPEED | float * 60 | int %}

  {% set park_x = printer["gcode_macro PRINT_END"].park_x | float %}
  {% set park_y = printer["gcode_macro PRINT_END"].park_y | float %}

  {% set config = printer.configfile.settings %}
  {% set home_x = config.safe_z_home.home_xy_position.x | float %}
  {% set home_y = config.safe_z_home.home_xy_position.y | float %}
  {% set z_hop = config.safe_z_home.z_hop | default(10) | float %}
  {% set max_z = printer.toolhead.axis_maximum.z %}
  {% set max_z_velocity = (config.printer.max_z_velocity | float * 60) | int %}
  {% set max_velocity = (config.printer.max_velocity | float * 60) | int %}

  RESPOND MSG="PRINT_END: max_layer_z={max_layer_z}mm, travel_speed={travel_speed}mm/min, retract={retract_length}mm at {retract_speed}mm/min"

  # Save state, retract a bit, and bounded z-hop
  SAVE_GCODE_STATE NAME=END_STATE
  G91; relative positioning
  G1 E-{retract_length} F{retract_speed}
  G90; back to absolute
  {% if max_layer_z + z_hop < max_z %}
    G1 Z{max_layer_z + z_hop} F{max_z_velocity}
  {% else %}
    G1 Z{max_z} F{max_z_velocity}
  {% endif %}

  # Present the part
  G1 X{park_x} Y{park_y} F{travel_speed}

  # Fans & heaters off
  M107
  TURN_OFF_HEATERS

  # Keep Z and E enabled until cool-down to prevent drop or ooze; uncomment to
  # release XY immediately:
  M84 X Y

  RESTORE_GCODE_STATE NAME=END_STATE MOVE=0
  RESPOND MSG="PRINT_END: done"
