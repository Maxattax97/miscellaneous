[gcode_macro PRINT_START]
description: Prepare machine for printing. Parameters: BED_TEMP, EXTRUDER_TEMP, TRAVEL_SPEED, IDLE_TEMP (optional), MESH_PROFILE (optional), SOAK (optional)
# Usage in slicer:
#   PRINT_START BED_TEMP={first_layer_bed_temperature[0]} EXTRUDER_TEMP={first_layer_temperature[0]} IDLE_TEMP={is_nil(idle_temperature[0]) ? 150 : idle_temperature[0]} SOAK=30
variable_park_x: 15.0
variable_park_y: 205.0
gcode:
  {% set bed_temp  = params.BED_TEMP | float %}
  {% set extruder_temp  = params.EXTRUDER_TEMP | float %}
  {% set travel_speed = params.TRAVEL_SPEED | float * 60 | int %}
  {% set idle_temp = params.IDLE_TEMP | default(150) | int %}
  {% set mesh_profile = params.MESH_PROFILE | default("default") | string %}
  {% set soak = params.SOAK | default(0) | float * 1000 | int %}

  {% set park_x = printer["gcode_macro PRINT_END"].park_x | float %}
  {% set park_y = printer["gcode_macro PRINT_END"].park_y | float %}

  {% set config = printer.configfile.settings %}
  {% set home_x = config.safe_z_home.home_xy_position[0] | float %}
  {% set home_y = config.safe_z_home.home_xy_position[1] | float %}
  {% set z_hop = config.safe_z_home.z_hop | default(10) | float %}
  {% set max_z_velocity = (config.printer.max_z_velocity | float * 60) | int %}
  {% set max_velocity = (config.printer.max_velocity | float * 60) | int %}

  RESPOND MSG="PRINT_START: bed={bed_temp}C, nozzle={extruder_temp}C, travel_speed={travel_speed}mm/min, idle_temp={idle_temp}C, mesh_profile='{mesh_profile}', soak={soak}s"

  # Start bed heating immediately
  SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={bed_temp}

  # Partial nozzle preheat to limit ooze while homing XY
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={idle_temp}

  # Home XY only while we're waiting for everything to heat up.
  RESPOND MSG="PRINT_START: homing XY"
  G28 X Y; home XY only

  # Move to bed center for Z probing later
  G90; absolute positioning
  G1 X{home_x} Y{home_y} F{travel_speed}; move to bed center
  # We cannot set Z yet, because it's not homed.

  # Bring bed to exact target and wait; then bring nozzle to final target and wait
  RESPOND MSG="PRINT_START: stabilizing bed at {bed_temp}C"
  TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={bed_temp - 0.5} MAXIMUM={bed_temp + 0.5}

  # Optional soak time (seconds) once bed reaches target â€” helps Z consistency on some machines
  {% if soak > 0 %}
    RESPOND MSG="PRINT_START: soaking for {soak / 1000.0} seconds"
    G4 P{soak}; sleep for SOAK milliseconds
  {% endif %}

  # Home Z with the bed/nozzle at temp to account for thermal expansion
  # If you use a probe: G28 Z will probe Z. If you use endstop: ensure it's safe at temp.
  RESPOND MSG="PRINT_START: homing Z"
  G28 Z; home Z axis

  # Raise Z to a safe height
  G1 Z{z_hop} F{max_z_velocity}; raise Z to safe height

  # Move into parking position just in case of ooze
  G1 X{park_x} Y{park_y} F{travel_speed}

  # Load bed mesh (do not run a full probe here unless you really want to)
  # NOTE: You must have a saved mesh with this name, or change 'default' below.
  RESPOND MSG="PRINT_START: loading (heated) bed mesh '{mesh_profile}'"
  BED_MESH_PROFILE LOAD="{mesh_profile}"

  # Full nozzle heat, it's safe to ooze now
  RESPOND MSG="PRINT_START: heating nozzle to {extruder_temp}C"
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={extruder_temp}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={extruder_temp - 0.5} MAXIMUM={extruder_temp + 0.5}

  PURGE_LINE

  RESPOND MSG="PRINT_START: handoff to slicer"
